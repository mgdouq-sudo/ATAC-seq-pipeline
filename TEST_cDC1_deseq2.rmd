```{r}
library(DESeq2)
library(readr)
library(tidyverse)
```

```{r}
# Read data
cDC1_counts <- read_tsv("GSE266583_cDC1_Raw_counts.tsv")
coldata <- read.csv("cDC1_coldata.csv", row.names = 1)
```
```{r}
head(cDC1_counts, 10)
```


```{r}
# Prepare count matrix
count_matrix <- as.matrix(cDC1_counts[, -1])
rownames(count_matrix) <- cDC1_counts$gene_id
count_matrix <- round(count_matrix)
```

```{r}
str(count_matrix[1:5, ])
```

```{r}
# Ensure order matches
count_matrix <- count_matrix[, rownames(coldata)]
```

```{r}
# Verify
all(colnames(count_matrix) == rownames(coldata))  # Should be TRUE
```

```{r}
# Create DESeq2 object
dds <- DESeqDataSetFromMatrix(
  countData = count_matrix,
  colData = coldata,
  design = ~ condition
)
```

```{r}
# Filter low counts
keep <- rowSums(counts(dds) >= 10) >= 2
dds <- dds[keep, ]
```

```{r}
# Run DESeq2
dds <- DESeq(dds)
```
```{r}
sizeFactors(dds)
```
```{r}
plotDispEsts(dds)
```
```{r}
colSums(count_matrix)
```
```{r}
nrow(count_matrix)
```
```{r}
head(resOrdered, 20)
```
```{r}
# Are your samples actually different?
vsd <- vst(dds, blind=FALSE)
sampleDists <- dist(t(assay(vsd)))
sampleDists
```

```{r}
# Get results (KO vs WT)
results_cDC1 <- results(dds, contrast = c("condition", "KO", "WT"))
```

```{r}
# Summary
summary(results_cDC1)
```

```{r}
# Filter significant genes
sig_cDC1 <- as.data.frame(results_cDC1)
sig_cDC1$gene <- rownames(sig_cDC1)
sig_cDC1 <- sig_cDC1[sig_cDC1$padj < 0.05 & !is.na(sig_cDC1$padj), ]
```

```{r}
# Add summary (optional but helpful)
cat("\n=== cDC1 Differential Expression Results ===\n")
cat("Total significant genes (FDR < 0.05):", nrow(sig_cDC1), "\n")
cat("Upregulated in KO:", sum(sig_cDC1$log2FoldChange > 0), "\n")
cat("Downregulated in KO:", sum(sig_cDC1$log2FoldChange < 0), "\n")
```

```{r}
nrow(count_matrix)
```

```{r}
# Save
write.csv(sig_cDC1, "cDC1_DESeq2_significant.csv", row.names = FALSE)

cat("cDC1 significant genes:", nrow(sig_cDC1), "\n")
```

```{r}
# Check sample order in the count file
colnames(cDC1_counts)[-1]  # Should show: a157, a160, a163, a166, a169, a172

# Check coldata order
rownames(coldata)  # Should match

# Check conditions are assigned correctly
coldata
#       condition replicate
# a157  KO        3
# a160  WT        1
# a163  WT        2
# a166  WT        3
# a169  KO        1
# a172  KO        2
```

